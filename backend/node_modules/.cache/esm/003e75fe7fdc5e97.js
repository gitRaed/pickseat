"use strict";;let getPointImportant,registerMessage,registerPointImportant,updatePointImportant,deletePointImportant,alarme,getTrajet,rechercherTrajet1,rechercherEscale,enregistrerTrajet,updateTrajet,deleteTrajet,registerDemande,getDemandeChauffeur,getDemandeVoyageur,getDemande,updateDemandeStatus,notificationChauffeur,notificationVoyageur,authDbEmail,distance,distanceForAlarm,addressToCoordinate,compareTrajet,compareDemande;_7fd‍.x([["codeRegisterMessage",()=>codeRegisterMessage],["codeGetPointImportant",()=>codeGetPointImportant],["codePointImportant",()=>codePointImportant],["codeUpdatePointImportant",()=>codeUpdatePointImportant],["codeDeletePointImportant",()=>codeDeletePointImportant],["codeAlarme",()=>codeAlarme],["codeGetTrajet",()=>codeGetTrajet],["codeRechercherTrajet",()=>codeRechercherTrajet],["codeEnregistrerTrajet",()=>codeEnregistrerTrajet],["codeUpdateTrajet",()=>codeUpdateTrajet],["codeRegisterDemande",()=>codeRegisterDemande],["codeGetDemandeUser",()=>codeGetDemandeUser],["codeGetDemande",()=>codeGetDemande],["codeUpdateDemandeStatus",()=>codeUpdateDemandeStatus],["codeNotification",()=>codeNotification]]);_7fd‍.w("../dataAccessLayer/requete_map.mjs",[["getPointImportant",["getPointImportant"],function(v){getPointImportant=v}],["registerMessage",["registerMessage"],function(v){registerMessage=v}],["registerPointImportant",["registerPointImportant"],function(v){registerPointImportant=v}],["updatePointImportant",["updatePointImportant"],function(v){updatePointImportant=v}],["deletePointImportant",["deletePointImportant"],function(v){deletePointImportant=v}],["alarme",["alarme"],function(v){alarme=v}],["getTrajet",["getTrajet"],function(v){getTrajet=v}],["rechercherTrajet1",["rechercherTrajet1"],function(v){rechercherTrajet1=v}],["rechercherEscale",["rechercherEscale"],function(v){rechercherEscale=v}],["enregistrerTrajet",["enregistrerTrajet"],function(v){enregistrerTrajet=v}],["updateTrajet",["updateTrajet"],function(v){updateTrajet=v}],["deleteTrajet",["deleteTrajet"],function(v){deleteTrajet=v}],["registerDemande",["registerDemande"],function(v){registerDemande=v}],["getDemandeChauffeur",["getDemandeChauffeur"],function(v){getDemandeChauffeur=v}],["getDemandeVoyageur",["getDemandeVoyageur"],function(v){getDemandeVoyageur=v}],["getDemande",["getDemande"],function(v){getDemande=v}],["updateDemandeStatus",["updateDemandeStatus"],function(v){updateDemandeStatus=v}],["notificationChauffeur",["notificationChauffeur"],function(v){notificationChauffeur=v}],["notificationVoyageur",["notificationVoyageur"],function(v){notificationVoyageur=v}]]);_7fd‍.w("../dataAccessLayer/requete_data.mjs",[["authDbEmail",["authDbEmail"],function(v){authDbEmail=v}]]);_7fd‍.w("./service/distance.mjs",[["distance",["distance"],function(v){distance=v}],["distanceForAlarm",["distanceForAlarm"],function(v){distanceForAlarm=v}],["addressToCoordinate",["addressToCoordinate"],function(v){addressToCoordinate=v}]]);_7fd‍.w("./service/compareDate.mjs",[["compareTrajet",["compareTrajet"],function(v){compareTrajet=v}],["compareDemande",["compareDemande"],function(v){compareDemande=v}]]);







































// * enregistrer message de contactUs du front
       async function codeRegisterMessage(email, message) {

    return registerMessage(email, message);
}

//#region pointImportant

       async function codeGetPointImportant(email) {

    return getPointImportant(email).then( (result) => {

        let data = [];

        for(let i = 0, n = result.length; i < n; i++) {

            data.push({
                id_points : result[i].id_points,
                message : result[i].message,
                latitude : result[i].latitude,
                longitude : result[i].longitude,
                sonner : result[i].sonner 
            });
        }

        return data;
    });
}


       async function codePointImportant(email, message, latitude, longitude, sonner) {

    return registerPointImportant(email, message, latitude, longitude, sonner);
}


       async function codeUpdatePointImportant(id, message, sonner) {

    return updatePointImportant(id, message, sonner);
}


       async function codeDeletePointImportant(id) {

    return deletePointImportant(id);
}


       async function codeAlarme(email, latitude_user, longitude_user) {

    const resultatAlarme = await alarme(email);
    let bool = false;
    let libelle = '';

    const coords_user = {
        lat : latitude_user,
        lng : longitude_user
    };

    for (let i = 0, n = resultatAlarme.length; i < n; i++) {

        let coords_point = {
            lat : resultatAlarme[i].latitude,
            lng: resultatAlarme[i].longitude
        };

        let isDist = await distanceForAlarm(coords_user, coords_point);

        if (isDist === true) {
            bool = true;
            libelle = resultatAlarme[i].message;
            console.log('Faire sonner le téléphone');
        }

    }

    return {
        isDist : bool,
        libelle : libelle
    };
}
//#endregion


//#region trajet

       async function codeGetTrajet(email) {

    const val = await compareTrajet(email); // * 'supprime' les vieux trajets
    
    const trajet = await getTrajet(email); // * retourne la liste des trajets de l'utilisateur filtrée, anciennes dates supprimées


    if (val === true) {

        return trajet;
    }
}


       async function codeRechercherTrajet(email, adresse_depart_user, adresse_arrive_user) {

    await compareTrajet(email); // * 'supprime' les vieux trajets

    const trajet = [];

    // * result = trajet chauffeur
    const result = await rechercherTrajet1(adresse_depart_user, adresse_arrive_user);

        if(result.length === 0) {

            // * s'il n'y a pas de trajet dans résult, chercher des trajets qui ont pour escale adresse_arrive_user
            // * s'occupe aussi d'ajouter les coordonnées des adresses du voyageur et du chauffeur au résultat
            return codeRechercherEscale(adresse_depart_user, adresse_arrive_user);

        } else {

            // * cas où le chauffeur et le voyageur ont le même trajet
            // * ajouter les coordonnées des adresses du voyageur et du chauffeur au résultat

            for(let i = 0, n = result.length; i < n; i++) {
                
                // * si le trajet n'est pas périmé
                if (result[i].validite === 0) {

                    result[i].coords_depart_user = await addressToCoordinate(adresse_depart_user);
                    result[i].coords_arrive_user =  await addressToCoordinate(adresse_arrive_user);
                    result[i].coords_depart_chauffeur = await addressToCoordinate(result[i].adresse_depart);
                    result[i].coords_arrive_chauffeur = await addressToCoordinate(result[i].adresse_arrive);
                    result[i].tarif = result[i].tarif_total;
                    trajet.push(result[i]);
                }
            }

            return trajet;
        }

}


async function codeRechercherEscale(adresse_depart_user, adresse_arrive_user) {

    let tableau = [];

    const result = await rechercherEscale();    // * result = trajet du chauffeur

    for(let i = 0, n = result.length; i < n; i++) {

        let trajet = result[i];
        let escale = trajet.escale;
        let depart_chauffeur = trajet.adresse_depart;
        let arrive_chauffeur = escale; // * arrive = escale car on ne veut afficher au front que le départ et l'escale, l'arrive du chauffeur ne regarde pas le voyageur
        let isDist = await distance(adresse_depart_user, adresse_arrive_user, depart_chauffeur, arrive_chauffeur);

        const escaleTr = escale.toLowerCase().split(' ');
        const arriver_userTr = adresse_arrive_user.toLowerCase().split(' ');

        const verif = await verifierEscaleEtArrive(escaleTr, arriver_userTr);

        // * ajoute les coordonnées du voyageur et chauffeur si les conditions sont respectées
        if (verif === true && isDist.bool === true && trajet.validite === 0){

            trajet.coords_depart_user = isDist.depart_user;
            trajet.coords_arrive_user = isDist.arrive_user;
            trajet.coords_depart_chauffeur = isDist.depart_chauffeur;
            trajet.coords_arrive_chauffeur = isDist.arrive_chauffeur;
            trajet.tarif = trajet.tarif_escale;

            tableau.push(trajet);
        }          
    }

    return tableau;

}

async function verifierEscaleEtArrive(escale, arriver_user) {

    // * Cette fonction vérifier si l'escale du chauffeur correspond à celui du voyageur

    // * Pourquoi faire une fonction juste pour sa? ben imagine si pour chercher 'solibra' le mec tape sa : Société de Limonaderies et Brasseries d'Afrique Solibra, Rue des Brasseurs, Arras, Zone 3, Treichville, Abidjan, 26, Côte d'Ivoire
    // * même si le chauffeur a une escale a solibra, l'algorithme ne vas pas encoyer au voyageur le chauffeur en question
    // * donc on fait un check pour voir si ya un mot dans l'adresse du voyageur qui correspond à l'escale du chauffeur

    // ! cette fonction ne marche pas avec la ponctuation, pour que l'exemple dans haut marche, faut retirer les virgules
    for(let j = 0, m = escale.length; j < m ; j++) {

        for(let k = 0, o = arriver_user.length; k < o; k++) {

            _7fd‍.g.console.log(escale[j], arriver_user[k]);
            if (escale[j] === arriver_user[k]){
                console.log('True');
                return true;
            }                
        }
    }
    
}


       async function codeEnregistrerTrajet(nom_chauffeur, prenom_chauffeur, email_chauffeur, numero_chauffeur, adresse_depart, adresse_arrive, heure_trajet, date_trajet, options, escale, tarif_total, tarif_escale) {

    return enregistrerTrajet(nom_chauffeur, prenom_chauffeur, email_chauffeur, numero_chauffeur, adresse_depart, adresse_arrive, heure_trajet, date_trajet, options, escale, tarif_total, tarif_escale);
}


       async function codeUpdateTrajet(id, adresse_depart, adresse_arrive, heure_trajet, date_trajet, options, escale, tarif_total, tarif_escale) {

    return updateTrajet(id, adresse_depart, adresse_arrive, heure_trajet, date_trajet, options, escale, tarif_total, tarif_escale);
}


//#endregion


//#region demandes

       async function codeRegisterDemande(email_chauffeur, email_voyageur, adresse_depart, adresse_arrive, date_trajet, heure_trajet, tarif) {

    try {

        const chauffeurData = await authDbEmail(email_chauffeur);
        const voyageurData = await authDbEmail(email_voyageur);

        const requete = await registerDemande(chauffeurData[0].nom, chauffeurData[0].prenom, chauffeurData[0].numero, email_chauffeur,
                                                voyageurData[0].nom, voyageurData[0].prenom, voyageurData[0].numero, email_voyageur,
                                                adresse_depart, adresse_arrive, date_trajet, heure_trajet, tarif);

        return requete;
    } catch (error) {
        _7fd‍.g.console.log('Code register demande error : ' + error);
    }
}

       async function codeGetDemandeUser(email, type) {

    await codeGetDemande(); // * 'supprime' les vieilles demandes

    if(type === 'chauffeur') {

        const demandeChauffeur = await getDemandeChauffeur(email);

        return demandeChauffeur;

    } else if (type === 'voyageur') {

        const demandeVoyageur = await getDemandeVoyageur(email);

        return demandeVoyageur;
    }
}

       async function codeGetDemande() {

    await compareDemande(); // * 'supprime' les vieilles demandes

    const listeDemande = await getDemande();

    if (listeDemande.length === 0 ) {

        return 'Pas de demandes';

    } else {

        return listeDemande;
    }
}

       async function codeUpdateDemandeStatus(id, status) {

    let message = 'Vous devez accepter ou refuser la demande et rien d\'autre! ';
    
    if (status === 'accepter' || status === 'refuser') {

        await updateDemandeStatus(id, status);
    }

    if (status === 'accepter') {

        message = 'Demande acceptée ';

    } else if (status === 'refuser') {

        message = 'Demande refusée ';
    }
    
    return message;
}

//#endregion


//#region notifications

       async function codeNotification(email, typeUser) {

    if(typeUser === 'chauffeur') {

        return await notificationChauffeur(email); 
        //* retourne le nombre de demandes du chauffeur avec un status 'attente'

    } else if (typeUser === 'voyageur') {

        return await notificationVoyageur(email);
        //* retourne le nombre de demandes du voyageur avec un status 'accepter'
    }   
}
//#endregion


