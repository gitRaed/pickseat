"use strict";;let express,bodyParser,cors,isAuth,authCodeEmail,codeRegisterMessage;_714‍.x([["map",()=>route]]);_714‍.w("express",[["default",["express"],function(v){express=v}]]);_714‍.w("body-parser",[["default",["bodyParser"],function(v){bodyParser=v}]]);_714‍.w("cors",[["*",null,function(v){cors=v}]]);_714‍.w("../../serviceLayer/isAuth.mjs",[["isAuth",["isAuth"],function(v){isAuth=v}]]);_714‍.w("../../serviceLayer/code_data.mjs",[["authCodeEmail",["authCodeEmail"],function(v){authCodeEmail=v}]]);_714‍.w("../../serviceLayer/code_map.mjs",[["codeRegisterMessage",["codeRegisterMessage"],function(v){codeRegisterMessage=v}]]);













const route = express.Router();

route.use(cors({
    origin: 'http://localhost/4200',
    credentials: true
}));
route.use(function (req, res, next) {
    // console.log("Request", req.url, req.body, req.method);
    res.header("Access-Control-Allow-Origin", "*");
    res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, authorization, Accept");
    if (req.method === 'OPTIONS') {
        res.end();
    } else {
        next();
    }
});
route.use(bodyParser.urlencoded({
    extended: true
}));
route.use(express.json());


route.post("/contactUs", async (req, res) => {


    try {
        // verifier si token es envoyé en header
        const verifToken = isAuth(req);
        if(verifToken.message !== '') {
            res.send({
                message: verifToken.message
            });
        } else {

            const {email, message} = req.body;
    
            // verifier si l'email est disponible dans la bdd
            authCodeEmail(email). then ( (result) => {

                if (result.auth !== true) {
                    res.send({
                        message: 'L\'utilisateur n\'existe pas'
                    });
                } else {
    
                    // enregister dans la bdd et envoyer le résultat
                    codeRegisterMessage(email, message).then( (result) => {
                        res.send({
                            message: result
                        });
                    });
                }

            });
            
    
        }
    } catch (error) {
        _714‍.g.console.log('Contact us error : ' + error);
        res.send({
            message: error
        });
        res.status(500);
    }
});




